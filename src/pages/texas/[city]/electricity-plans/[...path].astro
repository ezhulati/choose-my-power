---
/**
 * Texas City Faceted Navigation Route Handler
 * Handles URLs like /texas/dallas/electricity-plans/12-month/green-energy
 * Redirects to canonical /electricity-plans/dallas-tx/... format for SEO
 * 
 * This provides user-friendly URLs while maintaining canonical structure
 */

import { validateCitySlug, formatCitySlug } from '../../../../config/tdsp-mapping';

// Enable server-side rendering for dynamic routes
export const prerender = false;

console.log('🚀 Texas City Faceted Route: Processing request');

// Get dynamic parameters from URL
const { city, path } = Astro.params;

console.log(`📍 Texas faceted page requested: /texas/${city}/electricity-plans/${path || ''}`);

// Validate city parameter
if (!city) {
  console.log('❌ No city provided, redirecting to main Texas page');
  return Astro.redirect('/texas/');
}

// Convert city name to slug format (e.g., "dallas" -> "dallas-tx")
const citySlug = formatCitySlug(city);

// Validate the city exists in our TDSP mapping
if (!validateCitySlug(citySlug)) {
  console.log(`❌ Invalid city: ${city}, redirecting to 404`);
  return Astro.redirect('/404');
}

// Build canonical URL for redirect
let canonicalUrl = `/electricity-plans/${citySlug}`;

// Add filter path if provided
if (path) {
  // Convert plus-separated filters to slash-separated
  const filterPath = path.replace(/\+/g, '/');
  canonicalUrl += `/${filterPath}`;
}

// Ensure trailing slash
if (!canonicalUrl.endsWith('/')) {
  canonicalUrl += '/';
}

console.log(`↪️ Redirecting /texas/${city}/electricity-plans/${path || ''} -> ${canonicalUrl}`);

// Redirect to canonical faceted navigation URL
return Astro.redirect(canonicalUrl, 301);
---